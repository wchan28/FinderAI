name: Build All Platforms (with DMG)

on:
  workflow_dispatch:
    inputs:
      version_tag:
        description: 'Version tag (e.g., v1.2.3) - used for artifact naming'
        required: false
        default: 'dev'
        type: string

jobs:
  build-mac-arm64:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Build Python backend
        run: |
          cd backend
          python -m venv build_venv
          source build_venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller
          pyinstaller finderai_server.spec --clean --noconfirm
          mkdir -p ../ui/python-dist/mac
          cp -r dist/finderai-server/* ../ui/python-dist/mac/
          deactivate

      - name: Install Node dependencies
        run: |
          cd ui
          rm -f package-lock.json
          npm install

      - name: Import Code Signing Certificate
        env:
          CSC_LINK: ${{ secrets.CSC_LINK }}
          CSC_KEY_PASSWORD: ${{ secrets.CSC_KEY_PASSWORD }}
        run: |
          echo $CSC_LINK | base64 --decode > certificate.p12
          security create-keychain -p "" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "" build.keychain
          security import certificate.p12 -k build.keychain -P "$CSC_KEY_PASSWORD" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "" build.keychain
          rm certificate.p12

      - name: Build and Sign Electron app
        run: |
          cd ui
          # Retry logic for hdiutil race condition on macOS DMG builds
          for i in 1 2 3; do
            sync
            npm run build -- --publish never && break
            echo "Build attempt $i failed, retrying in 5 seconds..."
            sleep 5
          done
        env:
          CSC_LINK: ${{ secrets.CSC_LINK }}
          CSC_KEY_PASSWORD: ${{ secrets.CSC_KEY_PASSWORD }}
          VITE_CLERK_PUBLISHABLE_KEY: ${{ secrets.VITE_CLERK_PUBLISHABLE_KEY }}
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}

      - name: Verify AppleDouble files removed
        run: |
          cd ui/release
          for zip in *.zip; do
            if [ -f "$zip" ]; then
              echo "Checking $zip for AppleDouble files..."
              APPLEDOUBLE_COUNT=$(unzip -l "$zip" | grep "\._" | wc -l || echo "0")
              echo "  Found $APPLEDOUBLE_COUNT AppleDouble files"
              if [ "$APPLEDOUBLE_COUNT" -gt "0" ]; then
                echo "  WARNING: AppleDouble files still present in $zip"
                unzip -l "$zip" | grep "\._" | head -10
              fi
            fi
          done

      - name: Upload Mac ARM64 artifact
        uses: actions/upload-artifact@v4
        with:
          name: Docora-mac-arm64
          path: |
            ui/release/*.zip
            ui/release/*.dmg
            ui/release/*.yml
            ui/release/*.yaml
            ui/release/*.blockmap

  build-mac-x64:
    runs-on: macos-15-intel
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Build Python backend
        run: |
          cd backend
          python -m venv build_venv
          source build_venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller
          pyinstaller finderai_server.spec --clean --noconfirm
          mkdir -p ../ui/python-dist/mac
          cp -r dist/finderai-server/* ../ui/python-dist/mac/
          deactivate

      - name: Install Node dependencies
        run: |
          cd ui
          rm -f package-lock.json
          npm install

      - name: Import Code Signing Certificate
        env:
          CSC_LINK: ${{ secrets.CSC_LINK }}
          CSC_KEY_PASSWORD: ${{ secrets.CSC_KEY_PASSWORD }}
        run: |
          echo $CSC_LINK | base64 --decode > certificate.p12
          security create-keychain -p "" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "" build.keychain
          security import certificate.p12 -k build.keychain -P "$CSC_KEY_PASSWORD" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "" build.keychain
          rm certificate.p12

      - name: Build and Sign Electron app
        run: |
          cd ui
          # Retry logic for hdiutil race condition on macOS DMG builds
          for i in 1 2 3; do
            sync
            npm run build -- --publish never && break
            echo "Build attempt $i failed, retrying in 5 seconds..."
            sleep 5
          done
        env:
          CSC_LINK: ${{ secrets.CSC_LINK }}
          CSC_KEY_PASSWORD: ${{ secrets.CSC_KEY_PASSWORD }}
          VITE_CLERK_PUBLISHABLE_KEY: ${{ secrets.VITE_CLERK_PUBLISHABLE_KEY }}
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}

      - name: Verify AppleDouble files removed
        run: |
          cd ui/release
          for zip in *.zip; do
            if [ -f "$zip" ]; then
              echo "Checking $zip for AppleDouble files..."
              APPLEDOUBLE_COUNT=$(unzip -l "$zip" | grep "\._" | wc -l || echo "0")
              echo "  Found $APPLEDOUBLE_COUNT AppleDouble files"
              if [ "$APPLEDOUBLE_COUNT" -gt "0" ]; then
                echo "  WARNING: AppleDouble files still present in $zip"
                unzip -l "$zip" | grep "\._" | head -10
              fi
            fi
          done

      - name: Upload Mac x64 artifact
        uses: actions/upload-artifact@v4
        with:
          name: Docora-mac-x64
          path: |
            ui/release/*.zip
            ui/release/*.dmg
            ui/release/*.yml
            ui/release/*.yaml
            ui/release/*.blockmap

  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Build Python backend
        run: |
          cd backend
          python -m venv build_venv
          .\build_venv\Scripts\Activate.ps1
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller
          pyinstaller finderai_server.spec --clean --noconfirm
          New-Item -ItemType Directory -Force -Path ..\ui\python-dist\win
          Copy-Item -Recurse dist\finderai-server\* ..\ui\python-dist\win\

      - name: Install Node dependencies
        run: |
          cd ui
          Remove-Item -Force -ErrorAction SilentlyContinue package-lock.json
          npm install

      - name: Build Electron app
        run: cd ui && npm run build -- --publish never
        env:
          VITE_CLERK_PUBLISHABLE_KEY: ${{ secrets.VITE_CLERK_PUBLISHABLE_KEY }}
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: Docora-windows
          path: |
            ui/release/*.exe
            ui/release/*.yml
            ui/release/*.yaml
            ui/release/*.blockmap

  summary:
    needs: [build-mac-arm64, build-mac-x64, build-windows]
    runs-on: ubuntu-latest
    steps:
      - name: Build Summary
        run: |
          echo "## Build Complete! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All platform builds (including DMGs) are ready as workflow artifacts." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts include:" >> $GITHUB_STEP_SUMMARY
          echo "- **Mac ARM64**: ZIP + DMG" >> $GITHUB_STEP_SUMMARY
          echo "- **Mac x64**: ZIP + DMG" >> $GITHUB_STEP_SUMMARY
          echo "- **Windows**: EXE" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps for macOS Notarization:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. Download the Mac artifacts" >> $GITHUB_STEP_SUMMARY
          echo "2. Notarize the ZIP files locally:" >> $GITHUB_STEP_SUMMARY
          echo "   \`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "   xcrun notarytool submit Docora-*.zip --keychain-profile \"Docora-notarize\" --wait" >> $GITHUB_STEP_SUMMARY
          echo "   \`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "3. Staple and re-zip the app" >> $GITHUB_STEP_SUMMARY
          echo "4. Upload to GitHub Release" >> $GITHUB_STEP_SUMMARY
